# Sorty CLI (fileorg)
# Controls the Sorty app via URL schemes

APP_SCHEME="sorty"

function show_help {
    echo "Sorty CLI (fileorg)"
    echo ""
    echo "Usage: fileorg <command> [options]"
    echo ""
    echo "Commands:"
    echo "  organize <path> [options]    Start organizing a directory"
    echo "    --persona <id>             Select a persona (e.g. 'general', 'developer')"
    echo "    --auto                     Automatically start organization"
    echo ""
    echo "  duplicates <path> [options]  Scan for duplicates"
    echo "    --auto                     Automatically start scanning"
    echo ""
    echo "  status                       View Workspace Health"
    echo "  list                         View Watched Folders"
    echo "  settings [section]           Open settings"
    echo "    sections: general, ai, advanced, watched, exclusions"
    echo ""
    echo "  persona <action>             Manage personas"
    echo "    create                     Open persona creator"
    echo "    generate <prompt>          Generate a new persona from description"
    echo ""
    echo "  watched add <path>           Add a watched folder"
    echo ""
    echo "  rules add <pattern>          Add an exclusion rule"
    echo ""
    echo "  learnings                    Open Learnings dashboard"
    echo "  history                      Open History"
    echo "  help                         Open Help"
    echo ""
}

function open_url {
    open "$1"
}

function urlencode {
    # Basic URL encoding for spaces and special characters
    python3 -c "import urllib.parse, sys; print(urllib.parse.quote(sys.stdin.read().strip()))"
}

COMMAND=$1
shift

if [ -z "$COMMAND" ]; then
    show_help
    exit 0
fi

case "$COMMAND" in
    "organize")
        PATH_ARG=""
        PERSONA=""
        AUTOSTART="false"
        
        while [[ $# -gt 0 ]]; do
            case $1 in
                --persona)
                    PERSONA="$2"
                    shift
                    shift
                    ;;
                --auto)
                    AUTOSTART="true"
                    shift
                    ;;
                *)
                    if [ -z "$PATH_ARG" ]; then
                        PATH_ARG="$1"
                    fi
                    shift
                    ;;
            esac
        done
        
        URL="${APP_SCHEME}://organize?autostart=${AUTOSTART}"
        if [ ! -z "$PATH_ARG" ]; then
            # Convert relative path to absolute
            ABS_PATH=$(cd "$(dirname "$PATH_ARG")" && pwd)/$(basename "$PATH_ARG")
            ENCODED_PATH=$(echo -n "$ABS_PATH" | urlencode)
            URL="${URL}&path=${ENCODED_PATH}"
        fi
        if [ ! -z "$PERSONA" ]; then
            URL="${URL}&persona=${PERSONA}"
        fi
        open_url "$URL"
        ;;
        
    "duplicates")
        PATH_ARG=""
        AUTOSTART="false"
        
        while [[ $# -gt 0 ]]; do
            case $1 in
                --auto)
                    AUTOSTART="true"
                    shift
                    ;;
                *)
                    if [ -z "$PATH_ARG" ]; then
                        PATH_ARG="$1"
                    fi
                    shift
                    ;;
            esac
        done
        
        URL="${APP_SCHEME}://duplicates?autostart=${AUTOSTART}"
        if [ ! -z "$PATH_ARG" ]; then
            ABS_PATH=$(cd "$(dirname "$PATH_ARG")" && pwd)/$(basename "$PATH_ARG")
            ENCODED_PATH=$(echo -n "$ABS_PATH" | urlencode)
            URL="${URL}&path=${ENCODED_PATH}"
        fi
        open_url "$URL"
        ;;
        
    "status"|"health")
        open_url "${APP_SCHEME}://health"
        ;;
        
    "list"|"watched")
        if [ "$1" == "add" ]; then
            shift
            PATH_ARG=$1
            ABS_PATH=$(cd "$(dirname "$PATH_ARG")" && pwd)/$(basename "$PATH_ARG")
            ENCODED_PATH=$(echo -n "$ABS_PATH" | urlencode)
            URL="${APP_SCHEME}://watched?action=add&path=${ENCODED_PATH}"
            open_url "$URL"
        else
            # Open the watched folders list in settings
            open_url "${APP_SCHEME}://watched"
        fi
        ;;
        
    "settings")
        SECTION=$1
        URL="${APP_SCHEME}://settings"
        if [ ! -z "$SECTION" ]; then
            URL="${URL}?section=${SECTION}"
        fi
        open_url "$URL"
        ;;
        
    "persona")
        ACTION=$1
        shift
        URL="${APP_SCHEME}://persona?action=${ACTION}"
        
        if [ "$ACTION" == "generate" ]; then
            PROMPT="$*"
            ENCODED_PROMPT=$(echo -n "$PROMPT" | urlencode)
            URL="${URL}&generate=true&prompt=${ENCODED_PROMPT}"
        fi
        open_url "$URL"
        ;;
        
    "rules")
        ACTION=$1
        shift
        if [ "$ACTION" == "add" ]; then
            PATTERN=$1
            ENCODED_PATTERN=$(echo -n "$PATTERN" | urlencode)
            URL="${APP_SCHEME}://rules?action=add&pattern=${ENCODED_PATTERN}"
            open_url "$URL"
        else
             echo "Unknown action. Usage: rules add <pattern>"
        fi
        ;;
        
    "learnings")
        open_url "${APP_SCHEME}://learnings"
        ;;
        
    "history")
        open_url "${APP_SCHEME}://history"
        ;;
        
    "help")
        open_url "${APP_SCHEME}://help"
        ;;
        
    *)
        show_help
        ;;
esac
