name: Swift CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'Test Scope'
        required: true
        default: 'Unit'
        type: choice
        options:
        - Unit
        - UI
        - CLI
        - All
        - None
      release_type:
        description: 'Release Type'
        required: true
        default: 'None'
        type: choice
        options:
        - None
        - Beta
        - Production

jobs:
  build-and-test:
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Show environment info
        run: |
          sw_vers
          xcodebuild -version
          swift --version

      - name: Run Unit Tests (SPM)
        run: |
          set -o pipefail
          swift test --parallel 2>&1 | tee unit_test_output.log
          echo "✅ Unit tests completed"

      - name: Verify CLI Script (fileorg)
        run: |
          chmod +x CLI/fileorg
          
          # Verify scheme is updated to sorty
          echo "Checking scheme..."
          grep -q 'APP_SCHEME="sorty"' CLI/fileorg
          echo "✅ Scheme is set to 'sorty'"
          
          # Basic syntax check
          echo "Running syntax check..."
          bash -n CLI/fileorg
          echo "✅ Syntax is valid"
          
          # Verify help command works
          echo "Testing help output..."
          ./CLI/fileorg help 2>&1 | grep -q "Sorty CLI"
          echo "✅ Help command works"
          
          # Verify key commands are documented
          echo "Verifying documented commands..."
          ./CLI/fileorg help 2>&1 | grep -q "organize"
          ./CLI/fileorg help 2>&1 | grep -q "duplicates"
          ./CLI/fileorg help 2>&1 | grep -q "settings"
          echo "✅ All key commands documented"
          
          echo "✅ CLI script verification successful"

      - name: Build and Test Learnings CLI Tool
        run: |
          set -o pipefail
          
          # Build the CLI
          echo "Building learnings CLI..."
          swift build --product learnings 2>&1 | tee cli_build_output.log
          echo "✅ CLI build successful"
          
          # Test basic commands using swift run
          echo "Testing learnings CLI help..."
          swift run learnings help 2>&1 | grep -q "Learnings CLI"
          echo "✅ Help command works"
          
          echo "Testing learnings CLI info..."
          swift run learnings info 2>&1 | head -5
          echo "✅ Info command works"
          
          echo "✅ Learnings CLI tests completed"

      - name: Build the app (via script)
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh
          echo "✅ Build script succeeded"

      - name: Run UI Tests
        if: github.event_name == 'workflow_dispatch' && (inputs.test_scope == 'UI' || inputs.test_scope == 'All')
        run: |
          set -o pipefail
          xcodebuild test \
            -project "FileOrganiser.xcodeproj" \
            -scheme "FileOrganiser" \
            -destination 'platform=macOS' \
            -only-testing:FileOrganiserUITests \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee ui_test_output.log

          echo ""
          echo "=== UI Test Summary ==="
          grep -E "(Test Suite|Test Case|Executed|passed|failed)" ui_test_output.log | tail -30 || true
          
          if grep -q "TEST FAILED" ui_test_output.log 2>/dev/null; then
            echo "❌ UI Tests failed!"
            exit 1
          fi
          
          echo ""
          echo "✅ UI Tests completed"
        timeout-minutes: 30

      - name: Run Build and Release
        if: github.event_name == 'workflow_dispatch'
        run: |
          ARGS=""
          
          # correct scope mapping
          if [[ "${{ inputs.test_scope }}" == "UI" ]] || [[ "${{ inputs.test_scope }}" == "All" ]]; then
             ARGS="$ARGS --ui-tests"
          elif [[ "${{ inputs.test_scope }}" == "CLI" ]]; then
             ARGS="$ARGS --cli-only"
          elif [[ "${{ inputs.test_scope }}" == "None" ]]; then
             ARGS="$ARGS --no-tests"
          else
             # Default or Unit
             ARGS="$ARGS --skip-ui"
          fi
          
          echo "Running release.sh with args: $ARGS"
          ./scripts/release.sh $ARGS
        env:
           NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
           NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
           TEAM_ID: ${{ secrets.TEAM_ID }}

      - name: Archive Release Artifacts
        if: github.event_name == 'workflow_dispatch' && inputs.release_type != 'None'
        uses: actions/upload-artifact@v4
        with:
          name: Release-Artifacts
          path: releases/

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            unit_test_output.log
            build_output.log
            ui_test_output.log
            cli_build_output.log
            TestResults.xcresult
          retention-days: 7
          if-no-files-found: ignore
